<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HaexHub SDK Polyfill Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #0a0a0a;
      color: #fff;
    }
    .test-result {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 8px;
      background: #1a1a1a;
    }
    .test-result.success {
      border-left: 4px solid #10b981;
    }
    .test-result.error {
      border-left: 4px solid #ef4444;
    }
    .test-result h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
    }
    .test-result pre {
      margin: 0.5rem 0 0 0;
      padding: 0.5rem;
      background: #0a0a0a;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.875rem;
    }
    .console-log {
      margin: 2rem 0;
      padding: 1rem;
      background: #1a1a1a;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    .console-log h2 {
      margin: 0 0 1rem 0;
      font-size: 1.25rem;
    }
    .console-log .log-entry {
      padding: 0.25rem 0;
      font-family: monospace;
      font-size: 0.875rem;
    }
    .console-log .log-entry.haexhub {
      color: #10b981;
    }
  </style>
</head>
<body>
  <h1>HaexHub SDK Polyfill Test</h1>
  <p>Diese Seite testet, ob die Polyfills vom SDK korrekt geladen und aktiviert werden.</p>

  <div class="console-log">
    <h2>Console Output</h2>
    <div id="console-output"></div>
  </div>

  <div id="test-results"></div>

  <script type="module">
    // Intercept console logs
    const consoleOutput = document.getElementById('console-output');
    const originalLog = console.log;
    const originalWarn = console.warn;

    function addConsoleLog(type, ...args) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const text = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');

      if (text.includes('[HaexHub]')) {
        entry.classList.add('haexhub');
      }

      entry.textContent = `[${type}] ${text}`;
      consoleOutput.appendChild(entry);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    console.log = (...args) => {
      originalLog.apply(console, args);
      addConsoleLog('LOG', ...args);
    };

    console.warn = (...args) => {
      originalWarn.apply(console, args);
      addConsoleLog('WARN', ...args);
    };

    // Import SDK - This should trigger polyfills!
    console.log('=== Importing @haexhub/sdk ===');

    import { createHaexHubClient } from '@haexhub/sdk';

    console.log('=== SDK imported - Polyfills should be active now ===');

    // Test results container
    const resultsDiv = document.getElementById('test-results');

    function addTestResult(name, success, details) {
      const div = document.createElement('div');
      div.className = `test-result ${success ? 'success' : 'error'}`;

      const title = document.createElement('h3');
      title.textContent = `${success ? '✓' : '✗'} ${name}`;
      div.appendChild(title);

      if (details) {
        const pre = document.createElement('pre');
        pre.textContent = typeof details === 'object'
          ? JSON.stringify(details, null, 2)
          : String(details);
        div.appendChild(pre);
      }

      resultsDiv.appendChild(div);
    }

    // Run tests
    console.log('=== Running Polyfill Tests ===');

    // Test 1: localStorage
    try {
      localStorage.setItem('test_key', 'test_value');
      const value = localStorage.getItem('test_key');
      localStorage.removeItem('test_key');

      addTestResult('localStorage', value === 'test_value', {
        set: 'test_value',
        get: value,
        success: value === 'test_value'
      });
    } catch (e) {
      addTestResult('localStorage', false, e.message);
    }

    // Test 2: sessionStorage
    try {
      sessionStorage.setItem('test_key', 'test_value');
      const value = sessionStorage.getItem('test_key');

      addTestResult('sessionStorage', true, {
        note: 'sessionStorage is no-op polyfill',
        get: value
      });
    } catch (e) {
      addTestResult('sessionStorage', false, e.message);
    }

    // Test 3: Cookies
    try {
      document.cookie = 'test_cookie=test_value';
      const hasCookie = document.cookie.includes('test_cookie');

      addTestResult('Cookies', true, {
        set: 'test_cookie=test_value',
        cookies: document.cookie,
        found: hasCookie
      });
    } catch (e) {
      addTestResult('Cookies', false, e.message);
    }

    // Test 4: History API
    try {
      const originalState = history.state;
      history.pushState({ test: true }, '', '#test');

      addTestResult('History API', true, {
        note: 'pushState executed without SecurityError',
        state: history.state
      });

      // Restore
      if (originalState === null) {
        history.back();
      }
    } catch (e) {
      addTestResult('History API', false, e.message);
    }

    // Test 5: Check SDK functionality
    try {
      // Note: This will fail outside iframe, but that's expected
      const client = createHaexHubClient({ debug: true });
      addTestResult('SDK Client Creation', true, {
        note: 'SDK client created successfully',
        config: { debug: true }
      });
    } catch (e) {
      addTestResult('SDK Client Creation', false, {
        note: 'Expected to fail outside iframe',
        error: e.message
      });
    }

    console.log('=== Tests Complete ===');
  </script>
</body>
</html>
